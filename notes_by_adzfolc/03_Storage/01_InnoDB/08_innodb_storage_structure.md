# 08_innodb_storage_structure

* @see [fsp0fsp.h](../../../storage/innobase/include/fsp0fsp.h)

## 表空间文件组成结构
1. 新建数据库时, InnoDB 会初始化一个名为 ibdata1 的表空间文件.默认情况下, ibdata1 会存储
    * 所有表的数据
    * 系统表的数据, SYS_TABLES/SYS_COLUMNS/SYS_INDEXES/SYS_FIELDS.
    * 回滚段的数据 -> 最新版本的 InnoDB 支持参数设置回滚段的位置

2. 参数 innodb_file_per_table 设置,使得每个表有独立的表空间,而不是存储到公共的 ibdata1.独立的表空间只存储 表对应的B+树信息/索引/insert buffer ,其余信息仍存储在默认表空间中.

3. ibd 文件存储一个表的所有索引数据,通过 段/簇/页面 组成.

## 段
1. 段是表空间文件的主要组织结构,逻辑概念,用来管理物理文件.构成 索引/表/回滚段 的基本元素.创建一个索引(B+ Tree)同时会创建两个段,分别是 内节点段 和 叶子段.内节点段用于管理(存储)B+树中非叶子节点(页面)的数据,叶子段用于管理(存储)B+树中叶子节点的数据.
2. 在索引的增长过程中,所有新存储空间的申请都是从 **段** 逻辑概念中申请的,在内节点分裂时申请新节点就从内节点段中申请,在叶子节点分裂申请新节点需要从叶子段中申请.
3. 一个索引,包含两个段.一个表段的数目=索引数目*2.
4. ibd 文件由多个段组成.

## 簇
1. 簇(Extent)是构成段的基本元素,一个段由若干簇构成.一个簇是物理上连续分配的一段空间,每个段至少有一个簇,在创建一个段时会创建一个默认的簇.
2. 段扩展的最小单位是 簇.
3. 一个簇包含 64 个页面.

## 页面
1. 页面是 簇细分后的产物,是簇的基本组成单位,也是段管理的最小单位,数据库文件管理的最小单位,文件空间中分配的最小单位.
2. 表写入数据 -> 页面空间用完 => 当前簇分配页面 -> 簇64个页面用完 => 段分配新的簇,簇分配新的页面
3. 表空间被划分为相等的块,每个块是一个页面,一个页面默认16KB.

## 段,簇,页面 组织结构
1. 一个表空间可以有多个文件,每个文件有各自编号,创建一个表空间时,至少有一个文件,称为"0号文件". 0号文件的第一个页面( page_no 为0),存储这个表空间所有 段/簇/页面 管理的入口.一个页面是 16KB ,页面头信息占用部分空间,真正的管理信息数据从页面偏移为 FIL_PAGE_DATA(38) 位置开始.

2. 段 与 簇 中都会记录 空闲页的信息,区别在于:
    * 段中存储的是段内所有簇的空闲页信息
    * 簇中存储的是当前簇内的空闲页信息

Todo: Chp7 InnoDB 数据存储结构

## 页面结构管理

* [innodb_page_architecture](./innodb_page_architecture.png)

* 文件管理头信息 @see [fil0types.h](../../../storage/innobase/include/fil0types.h)

* 页面头信息    @see [page0types.h](../../../storage/innobase/include/page0types.h)

* 页面重组
    * dml 涉及数据不断插入删除,频繁操作会造成页面空间使用率低.
    * 问题:
        1. 空间占用比高,索引数据少
        2. 使用表的时候,大量无用 IO ,很多空间是碎片
        3. 数据库整体性能变差
    * 查看表空间使用率 -> `show table status like "%tablename%"\G`
    * 回收表中已被删除数据的空间 -> `alter table tablename engine innodb` -> 回收表的空间,相当于重组表
    * 页面插入类似,插入时如果没有大小合适的页面,进行页面重组. -> 新建 Buffer Pool ,将碎片页面数据一条一条插入新页面.插入完成后,将原始页面释放.

## 索引页面回收
* 考虑兄弟节点是否存在,存在的话递归更新索引,然后删除数据;不存在的话,删除数据,删除页面,释放空间.更新兄弟节点指针,将页面释放加入 free list
* 最左页面回收导致的父亲页面中索引记录指针的更新
    * 根据当前要删除的记录,找到父亲节点中的索引指针记录,递归删除.根据被删除记录的下一条记录,构造索引,指向的孩子不变,将刚刚构造的记录插入父亲节点的索引指针激励,维护 B+ Tree 本身特性.